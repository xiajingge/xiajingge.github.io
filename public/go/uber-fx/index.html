<!doctype html><html lang=en dir=auto data-theme=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="noindex, nofollow"><title>fx 依赖注入 | cubxxw is blog</title><meta name=keywords content="go,依赖注入,框架"><meta name=description content="fx依赖注入
简介
​	fx 是 uber 开源的一款依赖注入框架，依赖注入框架在之前接触过wire，目的是减少系统的启动复杂度，集中管理系统中的init功能函数。小项目引入依赖注入其实就没必要，甚至会凭空提高复杂度。
简单的依赖注入讲解
在我们写golang项目时，经常会遇到要使用其他包的对象。例如：
func NewA() TypeA 
func NewB(TypeA) TypeB
func NewC(TypeA, TypeB) TypeC
当我们需要一个 TypeC 时， 需要按照顺序手动构造 TypeA， TypeB，然后在构造 TypeC。
使用fx后
func main() {
    var x NewC
    fx.New(
        fx.Provide(NewA, NewB, NewC),
        fx.Populate(&amp;x)
    )
    fmt.Println(x)
}
我们将各个构造函数通过 Provide 函数注入到 fx.App 后，fx就会帮我们管理构造函数的调用，并且这种调用是 lazy的，即当某一个构造函数不存在被依赖时，那么它是不会被调用的。并且，这些构造函数被调用后构造的变量，是会被缓存的，所以当其他函数存在多个对其依赖时，只会被执行一次，之后都将直接返回第一构造的变量。
所以，我们使用 Provide 向fx注入构造函数时，注入顺序并不重要。
函数签名
这里会列出fx的主要的函数和方法，并对作用做出简要解释。
func New(opts ...Option) *App
func Provide(constructors ...interface{}) Option 
func Supply(values ...interface{}) Option
func Populate(targets ...interface{}) Option
func Invoke(funcs ...interface{}) Option


New"><meta name=author content><link rel=canonical href=http://localhost:1313/go/uber-fx/><link crossorigin=anonymous href=/assets/css/stylesheet.a29c24210eb31d9ce56f669c66a35c9c51b17376b7764e336a49af7dec914cf0.css integrity="sha256-opwkIQ6zHZzlb2acZqNcnFGxc3a3dk4zakmvfeyRTPA=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/go/uber-fx/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/categories/ title=categories><span>categories</span></a></li><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">fx 依赖注入</h1><div class=post-meta><span title='2026-02-10 22:03:52 +0800 CST'>February 10, 2026</span></div></header><div class=post-content><h1 id=fx依赖注入>fx依赖注入<a hidden class=anchor aria-hidden=true href=#fx依赖注入>#</a></h1><h2 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h2><p>​ fx 是 uber 开源的一款依赖注入框架，依赖注入框架在之前接触过wire，目的是减少系统的启动复杂度，集中管理系统中的init功能函数。小项目引入依赖注入其实就没必要，甚至会凭空提高复杂度。</p><h2 id=简单的依赖注入讲解>简单的依赖注入讲解<a hidden class=anchor aria-hidden=true href=#简单的依赖注入讲解>#</a></h2><p>在我们写golang项目时，经常会遇到要使用其他包的对象。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewA</span><span class=p>()</span><span class=w> </span><span class=nx>TypeA</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewB</span><span class=p>(</span><span class=nx>TypeA</span><span class=p>)</span><span class=w> </span><span class=nx>TypeB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewC</span><span class=p>(</span><span class=nx>TypeA</span><span class=p>,</span><span class=w> </span><span class=nx>TypeB</span><span class=p>)</span><span class=w> </span><span class=nx>TypeC</span><span class=w>
</span></span></span></code></pre></div><p>当我们需要一个 TypeC 时， 需要按照顺序手动构造 TypeA， TypeB，然后在构造 TypeC。</p><p>使用fx后</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>x</span><span class=w> </span><span class=nx>NewC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fx</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fx</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>NewA</span><span class=p>,</span><span class=w> </span><span class=nx>NewB</span><span class=p>,</span><span class=w> </span><span class=nx>NewC</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fx</span><span class=p>.</span><span class=nf>Populate</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>x</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>我们将各个构造函数通过 <code>Provide</code> 函数注入到 <code>fx.App</code> 后，fx就会帮我们管理构造函数的调用，并且这种调用是 lazy的，即当某一个构造函数不存在被依赖时，那么它是不会被调用的。并且，这些构造函数被调用后构造的变量，是会被缓存的，所以当其他函数存在多个对其依赖时，只会被执行一次，之后都将直接返回第一构造的变量。</p><p>所以，我们使用 <code>Provide</code> 向fx注入构造函数时，注入顺序并不重要。</p><h2 id=函数签名>函数签名<a hidden class=anchor aria-hidden=true href=#函数签名>#</a></h2><p>这里会列出fx的主要的函数和方法，并对作用做出简要解释。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>New</span><span class=p>(</span><span class=nx>opts</span><span class=w> </span><span class=o>...</span><span class=nx>Option</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>App</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Provide</span><span class=p>(</span><span class=nx>constructors</span><span class=w> </span><span class=o>...</span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>Option</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Supply</span><span class=p>(</span><span class=nx>values</span><span class=w> </span><span class=o>...</span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>Option</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Populate</span><span class=p>(</span><span class=nx>targets</span><span class=w> </span><span class=o>...</span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>Option</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Invoke</span><span class=p>(</span><span class=nx>funcs</span><span class=w> </span><span class=o>...</span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=nx>Option</span><span class=w>
</span></span></span></code></pre></div><ul><li><p><strong>New</strong></p><p>创建一个Fx应用，然后通过该应用进行程序的启动和管理。</p></li><li><p><strong>Provide</strong></p><p>将各个组件的构造器注册到Fx的应用容器中，Fx会在运行时调用它们并把返回的对象实例管理起来，供后续步骤使用。</p></li><li><p><strong>Supply</strong></p><p>函数传入的参数是已经构造完毕的值（value），也就是说 <code>Provide(NewC)</code> → <code>Supply(C)</code></p></li><li><p><strong>Populate</strong></p><p>在 <code>New</code> 函数外部，我们先var了一个 C，并且通过 <code>Provide</code> 注入 C 的构造函数，那么外部通过植入的变量C，在初始化完成后通过 <code>Provide</code> 的构造函数完成构造。这样就可以在 <code>New</code> 函数外部使用这个经过构造的变量。</p><p>可以把 Fx 想成一个“黑盒容器”,正常情况下：Fx 自己管理生命周期，对象只在 <code>Invoke</code> / <code>Provide</code> 链路里流转，但是有了Populate，就可以把容器里的对象 <strong>暴露到外部世界</strong></p></li><li><p><strong>Invoke</strong></p><p>添加业务执行的函数。这些函数是我的业务逻辑的入口，它们可以接收任何在fx.Provide()提供的类型作为参数，Fx会将这些类型的实例自动注入到函数中，使得在这些函数中无需手工创建依赖对象，直接使用依赖对象进行业务处理</p></li></ul><blockquote><p>需要注意的一点是 Invoke 注册的函数的运行是<strong>有顺序</strong>的，而 Provide 注入的构造函数并没有顺序</p></blockquote><h2 id=简单使用>简单使用<a hidden class=anchor aria-hidden=true href=#简单使用>#</a></h2><p>下面是一个官方例子</p><p>·</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;go.uber.org/fx&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;io&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net/http&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;os&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fx</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fx</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>NewHTTPServer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>NewEchoHandler</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>NewServeMux</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fx</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>srv</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>)</span><span class=w> </span><span class=p>{}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>).</span><span class=nf>Run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewHTTPServer</span><span class=p>(</span><span class=nx>lc</span><span class=w> </span><span class=nx>fx</span><span class=p>.</span><span class=nx>Lifecycle</span><span class=p>,</span><span class=w> </span><span class=nx>mux</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>ServeMux</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>srv</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Addr</span><span class=p>:</span><span class=w>    </span><span class=s>&#34;:8080&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Handler</span><span class=p>:</span><span class=w> </span><span class=nx>mux</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lc</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>fx</span><span class=p>.</span><span class=nx>Hook</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>OnStart</span><span class=p>:</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>ln</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>srv</span><span class=p>.</span><span class=nx>Addr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting HTTP server at&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>srv</span><span class=p>.</span><span class=nx>Addr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>go</span><span class=w> </span><span class=nx>srv</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>ln</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>OnStop</span><span class=p>:</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>srv</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>srv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// EchoHandler is an http.Handler that copies its request body</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// back to the response.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>EchoHandler</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// NewEchoHandler builds a new EchoHandler.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewEchoHandler</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=nx>EchoHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>EchoHandler</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// ServeHTTP handles an HTTP request to the /echo endpoint.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>EchoHandler</span><span class=p>)</span><span class=w> </span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed to handle request:&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// NewServeMux builds a ServeMux that will route requests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// to the given EchoHandler.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewServeMux</span><span class=p>(</span><span class=nx>echo</span><span class=w> </span><span class=o>*</span><span class=nx>EchoHandler</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>ServeMux</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mux</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/echo&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>echo</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>mux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>fx的启动顺序：</p><ol><li><p>构建依赖图（Provide阶段）</p><p>执行所有 <code>fx.Provide</code></p></li><li><p>执行所有 <code>fx.Invoke</code>（关键点）</p><p>按顺序执行</p></li><li><p>执行 <code>Lifecycle.OnStart</code>（真正启动）</p><p>按注册顺序</p></li><li><p>阻塞运行（Run 模式）</p></li><li><p>执行 <code>Lifecycle.OnStop</code>（真正启动）</p><p>按注册顺序的逆序</p></li></ol><h2 id=补充信息>补充信息<a hidden class=anchor aria-hidden=true href=#补充信息>#</a></h2><h3 id=fxanntated>fx.Anntated<a hidden class=anchor aria-hidden=true href=#fxanntated>#</a></h3><h4 id=介绍>介绍<a hidden class=anchor aria-hidden=true href=#介绍>#</a></h4><p><code>fx.Annotated</code>fx库中的一个结构体，主要用于给提供给容器的函数或调用的函数添加元数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Annotated</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Name</span><span class=w>   </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Target</span><span class=w> </span><span class=kd>interface</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Group</span><span class=w>  </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>Name字段可以指定该函数提供的结果在fx图中的名称。此名称可用于解析命名的实例。</li><li>Target字段是你想添加注释的构造函数。</li><li>Group字段可以指定结果应该添加到的值组。</li></ul><p>这是如何使用<code>fx.Annotated</code>的一个例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Result</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewResult</span><span class=p>()</span><span class=w> </span><span class=nx>Result</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>Result</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fx</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fx</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>fx</span><span class=p>.</span><span class=nx>Annotated</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>Name</span><span class=p>:</span><span class=w>   </span><span class=s>&#34;example&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>Target</span><span class=p>:</span><span class=w> </span><span class=nx>NewResult</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在这个例子中，我们使用 <code>fx.Annotated</code>将 <code>NewResult</code> 函数的返回值以 “example” 的名称提供给fx容器。然后，我们可以通过该名称在其他地方获取此结果。</p><p>这种提供命名实例的能力非常有用，特别是当你有多个实现同一接口的值时，在fx中需要明确指定使用哪一个。</p><h4 id=group字段的作用>Group字段的作用<a hidden class=anchor aria-hidden=true href=#group字段的作用>#</a></h4><p>在构建Fx应用程序时，你可能会遇到一种情况，也就是你需要把多个提供者的结果（通常是具有共同类型或接口的对象）集中在一起，这就是“Group”派上用场的地方。</p><p>以下是使用值组的一些典型情况：</p><ol><li><strong>多个提供者提供相同类型的结果</strong>：你可能有多个提供者都返回相同的类型，这在创建插件系统或模块化设计时很常见。在这种情况下，你可能需要将所有的插件（通过各自的提供者提供）聚合到一个列表中。</li><li><strong>需要动态注入依赖项</strong>：有时候，你可能不知道需要依赖多少或哪些具体的实例。例如，你的应用可能依赖一个插件系统，这个系统允许其他开发者添加他们自己的插件。在这种情况下，你可以使用值组来动态地收集和注入插件。</li><li><strong>需要将多个对象组合在一起进行处理</strong>：例如，你可能想把所有实现了特定接口的对象收集起来，并在单个函数中一次处理它们。通过使用值组，你可以轻松地将这些对象注入到这个函数中。</li></ol><p>值组允许你在不知道具体数量或具体实例的情况下注入一组对象，同时保持代码的解耦。这样可以帮助你创建更模块化和可扩展的应用程序。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;go.uber.org/fx&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ResType</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Value</span><span class=w> </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Provider1</span><span class=p>()</span><span class=w> </span><span class=nx>ResType</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>ResType</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span><span class=w> </span><span class=s>&#34;From Provider 1&#34;</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Provider2</span><span class=p>()</span><span class=w> </span><span class=nx>ResType</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>ResType</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span><span class=w> </span><span class=s>&#34;From Provider 2&#34;</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ResGroup</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fx</span><span class=p>.</span><span class=nx>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Group</span><span class=w> </span><span class=p>[]</span><span class=nx>ResType</span><span class=w> </span><span class=s>`group:&#34;myGroup&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fx</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fx</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>fx</span><span class=p>.</span><span class=nx>Annotated</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>Group</span><span class=p>:</span><span class=w>  </span><span class=s>&#34;myGroup&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>Target</span><span class=p>:</span><span class=w> </span><span class=nx>Provider1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>fx</span><span class=p>.</span><span class=nx>Annotated</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>Group</span><span class=p>:</span><span class=w>  </span><span class=s>&#34;myGroup&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>Target</span><span class=p>:</span><span class=w> </span><span class=nx>Provider2</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 不要用 *ResGroup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// fx.In 结构体 必须是值类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fx</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=nx>ResGroup</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Group</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>).</span><span class=nf>Run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=fxin--fxout>fx.in / fx.out<a hidden class=anchor aria-hidden=true href=#fxin--fxout>#</a></h3><h4 id=作用>作用<a hidden class=anchor aria-hidden=true href=#作用>#</a></h4><p><strong><code>fx.In</code> / <code>fx.Out</code> 是给 Fx 用的“结构体标记”</strong>。</p><p>用来告诉 Fx：这个 struct 不是普通数据，而是「依赖声明 / 结果声明」*</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;go.uber.org/fx&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>MyType1</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Value</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>MyType2</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Value</span><span class=w> </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ModuleAParams</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fx</span><span class=p>.</span><span class=nx>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Value1</span><span class=w> </span><span class=nx>MyType1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ModuleAResults</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fx</span><span class=p>.</span><span class=nx>Out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Value2</span><span class=w> </span><span class=nx>MyType2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>ModuleA</span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=nx>ModuleAParams</span><span class=p>)</span><span class=w> </span><span class=nx>ModuleAResults</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// use p.Value1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>ModuleAResults</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Value2</span><span class=p>:</span><span class=w> </span><span class=nx>MyType2</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span><span class=w> </span><span class=s>&#34;Hello, world&#34;</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v1</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>MyType1</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span><span class=w> </span><span class=mi>10</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>app</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fx</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fx</span><span class=p>.</span><span class=nf>Supply</span><span class=p>(</span><span class=nx>v1</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fx</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>ModuleA</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>fx</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>v2</span><span class=w> </span><span class=nx>MyType2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>v2</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span><span class=w> </span><span class=c1>// Output: Hello, world</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>app</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=supply>Supply<a hidden class=anchor aria-hidden=true href=#supply>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>fx</span><span class=p>.</span><span class=nf>Supply</span><span class=p>(</span><span class=nx>v1</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>“容器里已经有一个 <code>MyType1</code> 了”</p><h4 id=provide>Provide<a hidden class=anchor aria-hidden=true href=#provide>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>fx</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>ModuleA</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>👉 “如果有人要 <code>MyType2</code>， 那我可以用 调 <code>ModuleA</code> 来造”</p><h4 id=fxin>fx.In<a hidden class=anchor aria-hidden=true href=#fxin>#</a></h4><p>在<code>ModuleAParams</code>中</p><p>Fx 看到 <code>fx.In</code></p><ul><li>扫描 struct 的每个字段</li><li><strong>按字段类型去容器里找依赖</strong></li></ul><p>等价于<code>func ModuleA(v1 MyType1) ModuleAResults</code></p><p>如果没有 <code>fx.In</code> 会怎样？</p><p>❌ Fx 会认为：</p><blockquote><p>“哦，这是一个普通 struct，需要我提供一个 <code>ModuleAParams</code>”</p></blockquote><p>然后报错：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>missing type: ModuleAParams
</span></span></code></pre></div><h4 id=fxout>fx.Out<a hidden class=anchor aria-hidden=true href=#fxout>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ModuleAResults</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fx</span><span class=p>.</span><span class=nx>Out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Value2</span><span class=w> </span><span class=nx>MyType2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>它的作用是：</p><blockquote><p><strong>声明：ModuleA 要向容器“产出什么依赖”</strong></p></blockquote><ul><li><code>fx.Out</code> = “返回值拆包器”</li><li>Fx 看到 <code>fx.Out</code><ul><li>把 struct 里的每个字段<strong>分别注册成可注入的依赖</strong></li></ul></li></ul><p>相当于写成：<code>func ModuleA(v1 MyType1) MyType2</code></p><p>如果没有 <code>fx.Out</code> 会怎样？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ModuleAResults</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Value2</span><span class=w> </span><span class=nx>MyType2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>❌ Fx 会认为：</p><blockquote><p>“ModuleA 返回的是一个 <code>ModuleAResults</code> 类型”</p></blockquote><p>而你 <code>Invoke</code> 要的是 <code>MyType2</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>fx</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>v2</span><span class=w> </span><span class=nx>MyType2</span><span class=p>)</span><span class=w> </span><span class=p>{})</span><span class=w>
</span></span></span></code></pre></div><p>于是报错：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>missing</span><span class=w> </span><span class=kd>type</span><span class=p>:</span><span class=w> </span><span class=nx>MyType2</span><span class=w>
</span></span></span></code></pre></div><h4 id=fx-内部流程是>Fx 内部流程是：<a hidden class=anchor aria-hidden=true href=#fx-内部流程是>#</a></h4><ol><li>发现需要 <code>MyType2</code></li><li>找到 <code>ModuleA</code></li><li>发现 <code>ModuleA</code> 需要 <code>MyType1</code></li><li>容器里已经有（<code>fx.Supply(v1)</code>）</li><li>调 <code>ModuleA</code></li><li>用 <code>fx.Out</code> 把 <code>Value2</code> 注册成 <code>MyType2</code></li><li>注入到 <code>Invoke</code></li></ol><h4 id=实际使用例子>实际使用例子<a hidden class=anchor aria-hidden=true href=#实际使用例子>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Params</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fx</span><span class=p>.</span><span class=nx>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>DB</span><span class=w>     </span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Logger</span><span class=w> </span><span class=o>*</span><span class=nx>zap</span><span class=p>.</span><span class=nx>Logger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Cache</span><span class=w>  </span><span class=o>*</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Client</span><span class=w> </span><span class=s>`optional:&#34;true&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Results</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fx</span><span class=p>.</span><span class=nx>Out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Handler</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Service</span><span class=w> </span><span class=o>*</span><span class=nx>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Repo</span><span class=w>    </span><span class=o>*</span><span class=nx>Repo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewUserModule</span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=nx>Params</span><span class=p>)</span><span class=w> </span><span class=nx>Results</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>repo</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>NewRepo</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>svc</span><span class=w>  </span><span class=o>:=</span><span class=w> </span><span class=nf>NewService</span><span class=p>(</span><span class=nx>repo</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>h</span><span class=w>    </span><span class=o>:=</span><span class=w> </span><span class=nf>NewHandler</span><span class=p>(</span><span class=nx>svc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>Results</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Repo</span><span class=p>:</span><span class=w>    </span><span class=nx>repo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Service</span><span class=p>:</span><span class=w> </span><span class=nx>svc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Handler</span><span class=p>:</span><span class=w> </span><span class=nx>h</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nx>fx</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fx</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>NewHandler</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>fx</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;got handler&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>).</span><span class=nf>Run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>一句话理解作用：</p><blockquote><p><strong>fx.In：我需要什么</strong>
<strong>fx.Out：我提供什么，只能写fx看的懂、容器需要的东西，不能有方法，它的作用只是一个依赖声明清单</strong>
<strong>没有它们，Fx 只看类型，不懂语义</strong></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/go/>Go</a></li><li><a href=http://localhost:1313/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/>依赖注入</a></li><li><a href=http://localhost:1313/tags/%E6%A1%86%E6%9E%B6/>框架</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=http://localhost:1313/>cubxxw is blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>